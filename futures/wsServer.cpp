//commonGame
#include<sstream>
#include<fstream> // 标准库文件IO部分的头文件
#include <iostream>
#include <sys/time.h> 
#include <time.h> 
#include <math.h> 
#include<stdlib.h>
#include <boost/random/mersenne_twister.hpp>
#include <boost/algorithm/string.hpp>
#include <boost/random/uniform_int_distribution.hpp>
#include <boost/lexical_cast.hpp>
using namespace std;

 //websocket 
#include <websocketpp/server.hpp>
#include <websocketpp/config/asio_no_tls.hpp>
typedef websocketpp::server<websocketpp::config::asio> WebsocketServer;
typedef websocketpp::connection<websocketpp::config::asio> connection;
typedef WebsocketServer::message_ptr message_ptr;

using websocketpp::lib::placeholders::_1;
using websocketpp::lib::placeholders::_2;
using websocketpp::lib::bind;
WebsocketServer  server;
 //max 

boost::random::mt19937 gen;

string ONE_HOUR_KLINE_STR_ARR[400]={"","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""};

string FOUR_HOURS_KLINE_STR_ARR[400]={"","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""};

string ONE_DAY_KLINE_STR_ARR[400]={"","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""};

string ONE_WEEK_KLINE_STR_ARR[400]={"","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""};

string ONE_MONTH_KLINE_STR_ARR[400]={"","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""};

string FIFTEEN_MINS_KLINE_STR_ARR[400]={"","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""};

string ONE_MIN_KLINE_STR_ARR[400]={"","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""};

string TWO_ONE_MIN_KLINE_STR_ARR[400]={"","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""};

string TWO_ONE_MIN_KLINE_STR = "";

string ONE_DAY_POLE_STR_ARR[400]={"","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""};


string VOL_ARR[400]={"","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""};

string TICK_STR = "";

int SYMBOL_COUNT = 0;

int ONE_MIN_INDEX = 0;

int SPECIAL_ONE_MIN_INDEX = 0;


int FIFTEEN_MINS_INDEX = 0;

int SPECIAL_FIFTEEN_MINS_INDEX = 0;

long TICK_UPDATE_TS = 0;

string POSITION_STR= "";

string BAN_SYMBOL_STR= "";


string ACCOUNT_BALANCE_STR= "";

long POSITION_UPDATE_TS = 0;

long ACCOUNT_BALANCE_UPDATE_TS = 0;

string GROUP_ONE_MIN_KLINE= "";

string GROUP_FIFTEEN_MINS_KLINE= "";

bool toClient(string MSG,websocketpp::connection_hdl hdl)
{

    server.send(hdl,MSG, websocketpp::frame::opcode::text);
    return true;
}


void closeHdl(websocketpp::connection_hdl hdl)
{
    try
    {
        server.pause_reading(hdl); // <-- THIS LINE FIXES THE ERROR
        server.close(hdl, websocketpp::close::status::going_away, "");
    }
    catch(...)
    {
    }
}
bool validate(WebsocketServer *server, websocketpp::connection_hdl hdl)
{
    return true;
}
    /*********************************************************************************************************
    **********************************************************************************************************
                                      the operation when the websocket++ establish
    **********************************************************************************************************
    *********************************************************************************************************/
    
void OnOpen(WebsocketServer *server, websocketpp::connection_hdl hdl)
{
    //outfile << "----------------------------void OnOpen------------------------------" <<"\r\n";
    /*
    
    */
    // uint8_t buffer[4] = {1,1,1,1};
    // str_thisHdl=beString(server->get_con_from_hdl(hdl));
    // WebsocketServer::connection_ptr con=server->get_con_from_hdl(hdl);
    // websocketpp::http::parser::request rt = con->get_request(); 
    // const string& strUri = rt.get_uri();  
}
    /*********************************************************************************************************
    **********************************************************************************************************
                                      the operation when the websocket++ close 
    **********************************************************************************************************
    *********************************************************************************************************/

void OnClose(WebsocketServer *server, websocketpp::connection_hdl hdl)
{
//outfile << "----------------------------void OnClose------------------------------" <<"\r\n";
    // string str_thisHdl=beString(server->get_con_from_hdl(hdl));
    


}

/*********************************************************************************************************
    **********************************************************************************************************
                                      the operation when client send the message
    **********************************************************************************************************
    *********************************************************************************************************/
void OnMessage(WebsocketServer* s,websocketpp::connection_hdl hdl, message_ptr msg)
{   
    string clientToServerMsg = msg->get_payload();
    string firstMSG = clientToServerMsg.substr(0,1);

    if (firstMSG == "B"){
        string MSG_TO_CLIENT = TWO_ONE_MIN_KLINE_STR+"*"+TICK_STR+"*"+POSITION_STR+"*"+BAN_SYMBOL_STR+"*"+ACCOUNT_BALANCE_STR;
        toClient(MSG_TO_CLIENT,hdl);   
    }
    else if (firstMSG == "A"){
        string sendStr = ONE_MIN_KLINE_STR_ARR[0];
        for(int a=1;a<SYMBOL_COUNT;a++)
        {
            sendStr = sendStr+"@"+ONE_MIN_KLINE_STR_ARR[a];
        }
        toClient(sendStr,hdl);   
    }
    else if (firstMSG == "E"){
        string MSG_TO_CLIENT = "{\"s\":\"y\",\"d\":\""+POSITION_STR+"\",\"i\":\""+firstMSG+"\"}";
        toClient(MSG_TO_CLIENT,hdl);    
    }
    else if (firstMSG == "F"){
        ONE_MIN_INDEX = ONE_MIN_INDEX+1;
        if(ONE_MIN_INDEX>=SYMBOL_COUNT){
            ONE_MIN_INDEX = 0;
        }
        string MSG_TO_CLIENT = std::to_string(ONE_MIN_INDEX);
        toClient(MSG_TO_CLIENT,hdl);    
    }
    else if (firstMSG == "G"){
        SPECIAL_ONE_MIN_INDEX = SPECIAL_ONE_MIN_INDEX+1;
        if(SPECIAL_ONE_MIN_INDEX>=SYMBOL_COUNT){
            SPECIAL_ONE_MIN_INDEX = 0;
        }
        string MSG_TO_CLIENT = std::to_string(SPECIAL_ONE_MIN_INDEX);
        toClient(MSG_TO_CLIENT,hdl);    
    }
    else if(clientToServerMsg.size()>=19)
    {
        string mark = clientToServerMsg.substr(0,16);
        string valueInfo = clientToServerMsg.substr(16);
        if(mark == "sjaiyhsaoyosauio"){
            int thisIndex = atoi(valueInfo.substr(0,3).c_str());
            ONE_MIN_KLINE_STR_ARR[thisIndex] = valueInfo.substr(3);
        }else if(mark == "sajoiyfpdufiyiry"){
            int thisIndex = atoi(valueInfo.substr(0,3).c_str());
            TWO_ONE_MIN_KLINE_STR_ARR[thisIndex] = valueInfo.substr(3);
            TWO_ONE_MIN_KLINE_STR = TWO_ONE_MIN_KLINE_STR_ARR[0];
            for(int a=1;a<SYMBOL_COUNT;a++)
            {
                TWO_ONE_MIN_KLINE_STR = TWO_ONE_MIN_KLINE_STR+"@"+TWO_ONE_MIN_KLINE_STR_ARR[a];
            }
        }else if(mark == "sjaoihsoaitowljd"){
            long newTickUpdateTs = atol(valueInfo.substr(0,13).c_str());
            if(newTickUpdateTs>=TICK_UPDATE_TS){
                TICK_UPDATE_TS = newTickUpdateTs;
                TICK_STR = valueInfo.substr(13);        
            }
        }else if(mark == "gggoihsoaitowljd"){
            long newUpdateTs = atol(valueInfo.substr(0,13).c_str());
            if(newUpdateTs>=POSITION_UPDATE_TS){
                POSITION_UPDATE_TS = newUpdateTs;
                POSITION_STR = valueInfo.substr(13);           
            }
        }else if(mark == "abcoihsoaitowljd"){
                BAN_SYMBOL_STR = valueInfo;            
        }else if(mark == "fdsoihsoaitowljd"){
                long newUpdateTs = atol(valueInfo.substr(0,13).c_str());
                cout<<newUpdateTs<<endl;
                cout<<valueInfo<<endl;
                if(newUpdateTs>=ACCOUNT_BALANCE_UPDATE_TS){
                    ACCOUNT_BALANCE_UPDATE_TS = newUpdateTs;
                    ACCOUNT_BALANCE_STR = valueInfo.substr(13);           
                }
        }else if(mark == "bbboiyfpdufiyuyu"){
            SYMBOL_COUNT = atoi(valueInfo.substr(0,3).c_str());
        }

    }
}


int main()
{   

    // Set logging settings
    server.set_access_channels(websocketpp::log::alevel::connect);
    server.clear_access_channels(websocketpp::log::alevel::frame_payload);

    // Initialize ASIO
    server.init_asio();
    server.set_validate_handler(bind(&validate, &server,_1));
    // Register our open handler
    server.set_open_handler(bind(&OnOpen, &server,_1));
    // Register our close handler
    server.set_close_handler(bind(&OnClose, &server, _1));

    // Register our message handler
    // try
    // {
    server.set_message_handler(bind(&OnMessage,&server, _1,_2));
    // }
    // catch(...)
    // {
    // }
    //Listen on port 2152
    server.listen(3698);

    //Start the server accept loop
    server.start_accept();

    //Start the ASIO io_service run loop
    server.run();

    return 0;
}